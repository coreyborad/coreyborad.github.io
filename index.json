[{"categories":["documentation"],"content":"前言 AWS API Gateway是AWS Serverless的服務之一，用於建立REST API服務用，而有些狀況下，REST API我們想要只開放給特定服務，或是自己內部的AWS Service使用 本篇文章會簡單說明，如何透過Resource Policy來控制AWS API Gateway的Access ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:1:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"API Gateway Type API Gateway根據開放特性，還有延遲性等有不同的Type可以選擇 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:2:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Regional and Edge Optimized 這2種類型都是屬於Public Type，Internet都可以Access到，2者細部的差異在於Edge Optimized可以自行產生Cookie，來跟CDN做搭配，Regional則屬於放置在特地區域的API Gateway，當然還有更多細節差異，不過與本篇要探討的無關 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:2:1","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Private 如字面意思，這種Type需要搭配Resource Policy來過濾你的Request來源，也是本篇的重點，基本上可以有3種方式來進行Filter，AWS IAM, AWS VPC, AWS VPC Endpoint ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:2:2","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Resource Policy 除了可以針對整個API Gateway Resource去做限制之外，也可以細節到後續的Path限制，算是很大的細分 如果被Deny成功，後續也不會再近到AWS Lambda這層，可以節省費用 Deny的Response通常會長這樣 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:3:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"AWS Account { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"AWS\": [ \"arn:aws:iam::{{otherAWSAccountID}}:root\", \"arn:aws:iam::{{otherAWSAccountID}}:user/{{otherAWSUserName}}\", \"arn:aws:iam::{{otherAWSAccountID}}:role/{{otherAWSRoleName}}\" ] }, \"Action\": \"execute-api:Invoke\", \"Resource\": [ \"execute-api:/{{stageNameOrWildcard*}}/{{httpVerbOrWildcard*}}/{{resourcePathOrWildcard*}}\" ] } ] } ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:3:1","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"IP Range { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Deny\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\", \"Condition\" : { \"IpAddress\": { \"aws:SourceIp\": [ \"10.0.0.0/16\", \"200.200.200.200/32\" ] } } }, { \"Effect\": \"Allow\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\" } ] } ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:3:2","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"VPC { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Deny\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\", \"Condition\": { \"StringNotEquals\": { \"aws:sourceVpc\": \"{{vpcID}}\" } } }, { \"Effect\": \"Allow\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\" } ] } ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:3:3","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"VPC Endpoint { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Deny\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\", \"Condition\": { \"StringNotEquals\": { \"aws:sourceVpce\": \"{{vpc endpoint ID}}\" } } }, { \"Effect\": \"Allow\", \"Principal\": \"*\", \"Action\": \"execute-api:Invoke\", \"Resource\": \"execute-api:/{{stageNameOrWildcard}}/{{httpVerbOrWildcard}}/{{resourcePathOrWildcard}}\" } ] } ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:3:4","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Private Type 的限制與條件 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:4:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"VPC Endpoint 設定成Private Type有個先決條件，你也必須建立一個VPC Endpoint，然後去做綁定，不然Default Endpoint任何Service都會Access不到 Endpoint format會變成 https://{{API GATEWAY ID}}-vpce-{{VPC Endpoint ID}}.execute-api.{{Region}}.amazonaws.com/{{Stage Name}} ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:4:1","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Custom Domain API Gateway可以設定Domain功能，不過這功能只有在你設定成Edge Optimized 或 Regional才有用 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:4:2","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Resource Policy 一定要設定Resource Policy，不然你也沒有辦法Deploy ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:4:3","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Public Type的限制 ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:5:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"Policy on VPC and VPC Endpoint 你設定成Public，基本上這2個Type就完全沒有作用，可以參考下面AWS提供的文件 Ref: https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies-aws-condition-keys.html ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:5:1","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"},{"categories":["documentation"],"content":"總結表格 這邊以常用的狀況，將一些限制跟搭配做成Table供參考 APIGateway Type Need VPC Endpoint Resource Policy Way Available on Custom Domain Domain format Edge Optimized or Regional No AWS Account, AWS:SourceIP Yes https://{{CUSTOM DOMAIN}} Private Yes All No https://{{API GATEWAY ID}}-vpce-{{VPC Endpoint ID}}.execute-api.{{Region}}.amazonaws.com/{{Stage Name}} ","date":"2022-03-15","objectID":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/:6:0","tags":["aws","api-gateway","vpc","resource policy"],"title":"AWS API Gateway 之 Resource Policy探討","uri":"/posts/documentation/aws-vpc-api-gateway/aws-vpc-apigateway/"}]